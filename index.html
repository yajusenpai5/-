<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Standby Pro V4</title>
    <style>
        :root {
            --theme-color: #fff;
            --bg-color: #000;
            --accent-color: #0a84ff;
            --dim-color: #333;
            --active-tab-color: #fff;
        }
        
        /* 夜間モード（赤） */
        body.night-mode {
            --theme-color: #ff453a;
            --accent-color: #ff453a;
            --dim-color: #591815;
            --active-tab-color: #ff453a;
        }

        body, html {
            margin: 0; padding: 0;
            background-color: var(--bg-color);
            color: var(--theme-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            height: 100%; overflow: hidden;
            transition: color 0.5s ease;
        }

        /* 全体レイアウト */
        .main-container {
            display: flex;
            width: 100vw; height: 100vh;
        }

        /* === 左側エリア（ラッパー） === */
        .left-pane-wrapper {
            flex: 0 0 40%; /* 幅40% */
            border-right: 1px solid #222;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* 左側：スワイプコンテナ */
        .left-scroll-container {
            flex: 1;
            display: flex;
            overflow-x: scroll;
            overflow-y: hidden;
            scroll-snap-type: x mandatory;
            scrollbar-width: none; /* Firefox用 */
        }
        .left-scroll-container::-webkit-scrollbar { display: none; } /* Chrome/Safari用 */

        /* 左側：各セクション */
        .left-section {
            flex: 0 0 100%; /* 親の幅(40vw)に対して100% */
            height: 100%;
            scroll-snap-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        /* 左側タブボタン（固定） */
        .left-tabs {
            height: 60px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            padding-bottom: 10px;
            background: var(--bg-color); /* 背景透過防止 */
            z-index: 10;
        }
        .tab-btn {
            background: transparent; border: none;
            color: var(--theme-color); opacity: 0.3;
            font-size: 1rem; cursor: pointer;
            padding: 5px 10px;
            transition: opacity 0.3s;
        }
        .tab-btn.active {
            opacity: 1;
            font-weight: bold;
            border-bottom: 2px solid var(--theme-color);
        }

        /* コンテンツデザイン */
        .clock-time { font-size: 13vw; font-weight: 800; line-height: 0.9; font-variant-numeric: tabular-nums; }
        .clock-date { font-size: 3.5vw; margin-top: 10px; opacity: 0.8; }
        
        .timer-display { font-size: 8vw; font-weight: bold; font-variant-numeric: tabular-nums; margin-bottom: 10px;}
        .timer-inputs { display: flex; gap: 5px; align-items: center; margin-bottom: 15px; }
        .timer-inputs input {
            width: 3em; background: #222; border: 1px solid #444; color: #fff;
            font-size: 1.5rem; text-align: center; border-radius: 8px;
        }
        
        .action-btn {
            padding: 10px 25px; font-size: 1.2rem; border-radius: 25px; border: none;
            background: var(--dim-color); color: var(--theme-color); cursor: pointer; margin: 5px;
        }
        .action-btn.primary { background: var(--accent-color); color: #fff; }

        /* === 右側エリア === */
        .right-pane {
            flex: 1; /* 残り60% */
            overflow-x: scroll;
            overflow-y: hidden;
            scroll-snap-type: x mandatory;
            display: flex;
        }
        .widget {
            flex: 0 0 100%;
            height: 100%;
            scroll-snap-align: center;
            padding: 20px; box-sizing: border-box;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            overflow-y: auto;
        }

        /* ToDoデザイン */
        .todo-list { width: 100%; flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; margin-top:10px; }
        .todo-item { display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px; }
        .todo-item.completed { opacity: 0.5; text-decoration: line-through; }
        .checkbox { width: 24px; height: 24px; border: 2px solid var(--theme-color); border-radius: 50%; }
        .checkbox.checked { background: var(--theme-color); }

        /* 夜間モードボタン（左上に移動） */
        #mode-toggle {
            position: absolute; top: 15px; left: 15px;
            width: 40px; height: 40px; background: rgba(50,50,50,0.5);
            border-radius: 50%; border: none; color: #fff; z-index: 100; font-size: 20px;
        }

        /* 起動オーバーレイ */
        #start-overlay {
            position: fixed; inset: 0; background: #000; z-index: 999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
    </style>
</head>
<body>

    <div id="start-overlay">
        <h2 style="color:white;">Standby Pro V4</h2>
        <button class="action-btn primary" onclick="startApp()">開始</button>
    </div>

    <div class="main-container">
        <div class="left-pane-wrapper">
            <button id="mode-toggle" onclick="toggleNightMode()">☀</button>

            <div class="left-scroll-container" id="left-scroll" onscroll="syncLeftTabs()">
                
                <div class="left-section" id="sec-clock">
                    <div class="clock-time" id="clock">00:00</div>
                    <div class="clock-date" id="date">1月1日</div>
                </div>

                <div class="left-section" id="sec-alarm">
                    <h2>Alarm</h2>
                    <input type="time" id="alarm-time" style="font-size:2rem; background:#222; color:#fff; border:none; border-radius:10px; padding:10px; margin:20px 0;">
                    <button class="action-btn" id="alarm-toggle" onclick="toggleAlarm()">OFF</button>
                    <p id="alarm-status" style="color:#888; margin-top:10px;">未設定</p>
                </div>

                <div class="left-section" id="sec-timer">
                    <h2>Timer</h2>
                    <div class="timer-display" id="timer-display">00:00</div>
                    
                    <div class="timer-inputs">
                        <input type="number" id="tm-min" placeholder="00" min="0" onchange="saveTimerSetting()"> 分
                        <input type="number" id="tm-sec" placeholder="00" min="0" max="59" onchange="saveTimerSetting()"> 秒
                    </div>

                    <div>
                        <button class="action-btn primary" onclick="startTimer()">Start</button>
                        <button class="action-btn" onclick="resetTimer()">Reset</button>
                    </div>
                </div>
            </div>

            <div class="left-tabs">
                <button class="tab-btn active" id="tab-clock" onclick="scrollToLeft(0)">時計</button>
                <button class="tab-btn" id="tab-alarm" onclick="scrollToLeft(1)">アラーム</button>
                <button class="tab-btn" id="tab-timer" onclick="scrollToLeft(2)">タイマー</button>
            </div>
        </div>

        <div class="right-pane">
            <div class="widget">
                <h2>ToDo</h2>
                <div style="display:flex; gap:5px; width:100%;">
                    <input type="text" id="todo-input" style="flex:1; padding:10px; border-radius:5px; border:none;" placeholder="予定...">
                    <input type="time" id="todo-time" style="border-radius:5px; border:none;">
                </div>
                <button class="action-btn primary" style="width:100%; margin-top:5px;" onclick="addTodo()">追加</button>
                <div class="todo-list" id="todo-list"></div>
            </div>

            <div class="widget">
                <h2>Weather</h2>
                <div id="weather-display" style="text-align:center;">
                    <button class="action-btn" onclick="getWeather()">取得</button>
                </div>
            </div>

            <div class="widget">
                <h2 id="cal-title">Calendar</h2>
                <div id="calendar" style="display:grid; grid-template-columns:repeat(7,1fr); gap:8px; text-align:center; font-size:1.5rem; width:100%;"></div>
            </div>
        </div>
    </div>

    <script>
        // === 音声コンテキスト ===
        let audioCtx;
        function initAudio() { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
        function playBeep() {
            if(!audioCtx) initAudio();
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.frequency.setValueAtTime(880, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.5, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime+0.5);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime+0.5);
        }

        // === アプリ基本 ===
        async function startApp() {
            document.getElementById('start-overlay').style.display = 'none';
            initAudio();
            try { if('wakeLock' in navigator) await navigator.wakeLock.request('screen'); } catch(e){}
            if(Notification.permission === 'default') Notification.requestPermission();
            
            // タイマー設定の復元
            const savedMin = localStorage.getItem('timer_min');
            const savedSec = localStorage.getItem('timer_sec');
            if(savedMin) document.getElementById('tm-min').value = savedMin;
            if(savedSec) document.getElementById('tm-sec').value = savedSec;
            if(savedMin || savedSec) updateTimerDisplayFromInput();
        }

        function toggleNightMode() {
            document.body.classList.toggle('night-mode');
            const btn = document.getElementById('mode-toggle');
            btn.innerText = document.body.classList.contains('night-mode') ? '☾' : '☀';
        }

        // === 左側スワイプ＆タブ連携 ===
        function scrollToLeft(index) {
            const container = document.getElementById('left-scroll');
            const width = container.offsetWidth;
            container.scrollTo({ left: width * index, behavior: 'smooth' });
        }

        function syncLeftTabs() {
            const container = document.getElementById('left-scroll');
            const index = Math.round(container.scrollLeft / container.offsetWidth);
            
            ['clock', 'alarm', 'timer'].forEach((id, i) => {
                const btn = document.getElementById('tab-' + id);
                if(i === index) btn.classList.add('active');
                else btn.classList.remove('active');
            });
        }

        // === 時計・アラーム ===
        setInterval(() => {
            const now = new Date();
            const h = String(now.getHours()).padStart(2,'0');
            const m = String(now.getMinutes()).padStart(2,'0');
            const s = String(now.getSeconds()).padStart(2,'0');
            document.getElementById('clock').innerHTML = `${h}:${m}<span style="font-size:0.5em;">${s}</span>`;
            
            const days = ['日','月','火','水','木','金','土'];
            document.getElementById('date').innerText = `${now.getMonth()+1}月${now.getDate()}日 (${days[now.getDay()]})`;

            checkAlarm(h, m, s);
            checkTodoReminders(h, m);
        }, 1000);

        let alarmEnabled = false;
        function toggleAlarm() {
            const btn = document.getElementById('alarm-toggle');
            if(!alarmEnabled) {
                if(!document.getElementById('alarm-time').value) return alert('時間を設定してください');
                alarmEnabled = true; btn.innerText = "ON"; btn.classList.add('primary');
                document.getElementById('alarm-status').innerText = "ON";
            } else {
                alarmEnabled = false; btn.innerText = "OFF"; btn.classList.remove('primary');
                document.getElementById('alarm-status').innerText = "未設定";
            }
        }
        function checkAlarm(h, m, s) {
            if(alarmEnabled && document.getElementById('alarm-time').value === `${h}:${m}` && s === '00') {
                playBeep(); alert('アラーム！'); toggleAlarm();
            }
        }

        // === タイマー（カスタム入力＆記憶） ===
        let timerInterval;
        let timerSeconds = 0;

        function saveTimerSetting() {
            const min = document.getElementById('tm-min').value || 0;
            const sec = document.getElementById('tm-sec').value || 0;
            localStorage.setItem('timer_min', min);
            localStorage.setItem('timer_sec', sec);
            updateTimerDisplayFromInput();
        }

        function updateTimerDisplayFromInput() {
            const min = parseInt(document.getElementById('tm-min').value || 0);
            const sec = parseInt(document.getElementById('tm-sec').value || 0);
            const total = min * 60 + sec;
            const m = Math.floor(total / 60).toString().padStart(2,'0');
            const s = (total % 60).toString().padStart(2,'0');
            document.getElementById('timer-display').innerText = `${m}:${s}`;
        }

        function startTimer() {
            const min = parseInt(document.getElementById('tm-min').value || 0);
            const sec = parseInt(document.getElementById('tm-sec').value || 0);
            timerSeconds = min * 60 + sec;
            
            if(timerSeconds <= 0) return;
            saveTimerSetting(); // スタート時にも保存

            if(timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                if(timerSeconds > 0) {
                    timerSeconds--;
                    const m = Math.floor(timerSeconds / 60).toString().padStart(2,'0');
                    const s = (timerSeconds % 60).toString().padStart(2,'0');
                    document.getElementById('timer-display').innerText = `${m}:${s}`;
                } else {
                    clearInterval(timerInterval);
                    playBeep(); alert('タイマー終了');
                }
            }, 1000);
        }
        function resetTimer() {
            clearInterval(timerInterval);
            updateTimerDisplayFromInput(); // 入力値に戻す
        }

        // === その他（ToDo, 天気, カレンダー） ===
        let todos = JSON.parse(localStorage.getItem('standby_todos_v4') || '[]');
        renderTodos();
        function addTodo() {
            const text = document.getElementById('todo-input').value;
            const time = document.getElementById('todo-time').value;
            if(!text) return;
            todos.push({ id: Date.now(), text, time, completed: false, notified: false });
            localStorage.setItem('standby_todos_v4', JSON.stringify(todos));
            renderTodos(); document.getElementById('todo-input').value = '';
        }
        function renderTodos() {
            const list = document.getElementById('todo-list'); list.innerHTML = '';
            todos.forEach(t => {
                const div = document.createElement('div');
                div.className = `todo-item ${t.completed?'completed':''}`;
                div.innerHTML = `<div class="checkbox ${t.completed?'checked':''}" onclick="toggleTodo(${t.id})"></div><div>${t.text}</div>`;
                list.appendChild(div);
            });
        }
        function toggleTodo(id) {
            const t = todos.find(x => x.id === id); if(t) t.completed = !t.completed;
            localStorage.setItem('standby_todos_v4', JSON.stringify(todos)); renderTodos();
        }
        function checkTodoReminders(h, m) {
            todos.forEach(t => {
                if(t.time === `${h}:${m}` && !t.completed && !t.notified) {
                    playBeep(); new Notification('ToDo', {body:t.text}); t.notified = true;
                }
            });
        }
        
        // 天気・カレンダー（簡易化して記述）
        function getWeather() {
            const d = document.getElementById('weather-display'); d.innerText = 'Loading...';
            navigator.geolocation.getCurrentPosition(async p => {
                const r = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${p.coords.latitude}&longitude=${p.coords.longitude}&current_weather=true&timezone=auto`);
                const j = await r.json();
                d.innerHTML = `<div style="font-size:4rem;font-weight:bold;">${j.current_weather.temperature}°</div>`;
            });
        }
        
        // カレンダー表示
        const calNow = new Date();
        document.getElementById('cal-title').innerText = `${calNow.getFullYear()}年 ${calNow.getMonth()+1}月`;
        const week = ['日','月','火','水','木','金','土'];
        let calHtml = '';
        week.forEach(d => calHtml += `<div style="font-weight:bold;color:var(--theme-color);">${d}</div>`);
        const fDay = new Date(calNow.getFullYear(), calNow.getMonth(), 1).getDay();
        const lDate = new Date(calNow.getFullYear(), calNow.getMonth()+1, 0).getDate();
        for(let i=0; i<fDay; i++) calHtml += `<div></div>`;
        for(let i=1; i<=lDate; i++) {
            const isToday = i===calNow.getDate() ? 'background:var(--theme-color);color:var(--bg-color);border-radius:50%;' : '';
            calHtml += `<div style="${isToday}">${i}</div>`;
        }
        document.getElementById('calendar').innerHTML = calHtml;

    </script>
</body>
</html>
