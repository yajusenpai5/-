<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Standby Pro V4</title>
    <style>
        :root {
            --theme-color: #fff;
            --bg-color: #000;
            --accent-color: #0a84ff;
            --dim-color: #333;
            --panel-border: 1px solid #222;
        }
        
        body.night-mode {
            --theme-color: #ff453a;
            --accent-color: #ff453a;
            --dim-color: #591815;
            --panel-border: 1px solid #440000;
        }

        body, html {
            margin: 0; padding: 0;
            background-color: var(--bg-color);
            color: var(--theme-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            height: 100%; overflow: hidden;
            transition: all 0.5s ease;
        }

        /* レイアウト全体 */
        .main-container {
            display: flex;
            width: 100vw; height: 100vh;
        }

        /* === 左側エリア（スワイプ対応） === */
        .left-pane-wrapper {
            flex: 0 0 40%; /* 左側40% */
            border-right: var(--panel-border);
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .left-scroll-container {
            flex: 1;
            display: flex;
            overflow-x: scroll; /* 横スクロール有効 */
            overflow-y: hidden;
            scroll-snap-type: x mandatory; /* スナップ有効 */
            scrollbar-width: none; /* スクロールバー隠す */
        }
        .left-scroll-container::-webkit-scrollbar { display: none; }

        .left-page {
            flex: 0 0 100%; /* 幅100% */
            scroll-snap-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        /* 時計デザイン */
        .clock-time { font-size: 13vw; font-weight: 800; line-height: 0.9; font-variant-numeric: tabular-nums; }
        .clock-date { font-size: 3.5vw; margin-top: 10px; opacity: 0.8; }

        /* 左下タブナビゲーション */
        .left-tabs {
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            border-top: var(--panel-border);
            background: var(--bg-color);
            z-index: 10;
        }
        .tab-dot {
            width: 10px; height: 10px;
            border-radius: 50%;
            background: #444;
            transition: background 0.3s;
        }
        .tab-dot.active { background: var(--theme-color); }
        .tab-label {
            font-size: 0.8rem; color: #888;
            background: none; border: none; cursor: pointer;
        }
        .tab-label.active { color: var(--theme-color); font-weight: bold; }

        /* === アラーム・タイマー共通 UI === */
        .input-row { display: flex; align-items: center; gap: 5px; margin: 15px 0; }
        input[type="number"], input[type="time"] {
            background: #222; border: 1px solid #444; color: #fff;
            font-size: 1.5rem; padding: 10px; border-radius: 8px;
            text-align: center; width: 80px;
        }
        .timer-label { font-size: 1rem; opacity: 0.7; }
        
        .action-btn {
            padding: 10px 25px; font-size: 1.2rem; border-radius: 25px; border: none;
            background: var(--dim-color); color: var(--theme-color); cursor: pointer;
            min-width: 100px;
        }
        .action-btn.primary { background: var(--theme-color); color: var(--bg-color); font-weight: bold; }
        
        .timer-display { font-size: 16vw; font-weight: 700; font-variant-numeric: tabular-nums; line-height: 1; }

        /* === 右側エリア（スワイプ対応） === */
        .right-pane {
            flex: 1; /* 右側60% */
            overflow-x: scroll;
            overflow-y: hidden;
            scroll-snap-type: x mandatory;
            display: flex;
            scrollbar-width: none;
        }
        .right-pane::-webkit-scrollbar { display: none; }

        .widget {
            flex: 0 0 100%;
            height: 100%;
            scroll-snap-align: center;
            padding: 20px; box-sizing: border-box;
            display: flex; flex-direction: column;
            align-items: center;
            overflow-y: auto;
        }

        /* ToDoリスト */
        .todo-input-container { width: 100%; display: flex; gap: 5px; margin-bottom: 15px; }
        .todo-text-input { flex: 1; background: #222; border: none; color: white; padding: 10px; border-radius: 8px; font-size: 1rem; }
        .todo-list { width: 100%; flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
        .todo-item { display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px; }
        .todo-item.completed { opacity: 0.5; text-decoration: line-through; }
        .checkbox { width: 24px; height: 24px; border: 2px solid var(--theme-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .checkbox.checked::after { content: '✔'; font-size: 16px; color: var(--theme-color); }
        .delete-btn { background: none; border: none; color: #888; font-size: 1.2rem; margin-left: auto; }

        /* 天気・カレンダー */
        .weather-temp { font-size: 6rem; font-weight: bold; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; width: 100%; font-size: 1.4rem; }
        .cal-today { background: var(--theme-color); color: var(--bg-color); border-radius: 50%; width: 40px; height: 40px; display:flex; align-items:center; justify-content:center; margin:0 auto;}

        /* --- UIパーツ --- */
        /* 夜間モードボタン（左上に移動） */
        #mode-toggle {
            position: fixed; top: 20px; left: 20px;
            width: 44px; height: 44px;
            background: rgba(50,50,50,0.6);
            border-radius: 50%; border: 1px solid #666;
            color: #fff; z-index: 100;
            font-size: 20px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }

        /* 起動オーバーレイ */
        #start-overlay {
            position: fixed; inset: 0; background: #000; z-index: 999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
    </style>
</head>
<body>

    <div id="start-overlay">
        <h2>Standby Pro V4</h2>
        <p style="color:#888; margin:20px 0;">画面タップでスタート</p>
        <button class="action-btn primary" onclick="startApp()">開始</button>
    </div>

    <button id="mode-toggle" onclick="toggleNightMode()">☀</button>

    <div class="main-container">
        <div class="left-pane-wrapper">
            <div class="left-scroll-container" id="left-scroll" onscroll="updateLeftTabs()">
                
                <div class="left-page" id="page-clock">
                    <div class="clock-time" id="clock">00:00</div>
                    <div class="clock-date" id="date">1月1日(月)</div>
                </div>

                <div class="left-page" id="page-alarm">
                    <h2 style="opacity:0.6;">ALARM</h2>
                    <input type="time" id="alarm-time" style="font-size:2rem; width:auto;">
                    <div style="margin-top:20px;">
                        <button class="action-btn" id="alarm-toggle" onclick="toggleAlarm()">OFF</button>
                    </div>
                    <p id="alarm-status" style="margin-top:15px; color:#888;">設定なし</p>
                </div>

                <div class="left-page" id="page-timer">
                    <h2 style="opacity:0.6;">TIMER</h2>
                    <div class="timer-display" id="timer-display">00:00</div>
                    
                    <div class="input-row">
                        <input type="number" id="timer-min" placeholder="分" min="0" max="999" onchange="saveTimerSetting()">
                        <span class="timer-label">分</span>
                        <input type="number" id="timer-sec" placeholder="秒" min="0" max="59" onchange="saveTimerSetting()">
                        <span class="timer-label">秒</span>
                    </div>

                    <div style="display:flex; gap:15px;">
                        <button class="action-btn primary" id="timer-btn" onclick="toggleTimer()">Start</button>
                        <button class="action-btn" onclick="resetTimer()">Reset</button>
                    </div>
                </div>
            </div>

            <div class="left-tabs">
                <button class="tab-label active" id="tab-btn-0" onclick="scrollToPage(0)">時計</button>
                <button class="tab-label" id="tab-btn-1" onclick="scrollToPage(1)">アラーム</button>
                <button class="tab-label" id="tab-btn-2" onclick="scrollToPage(2)">タイマー</button>
            </div>
        </div>

        <div class="right-pane">
            
            <div class="widget">
                <h2>ToDo & Reminder</h2>
                <div class="todo-input-container">
                    <input type="text" id="todo-input" class="todo-text-input" placeholder="予定...">
                    <input type="time" id="todo-time" style="width:80px; background:#333; border:none; color:#fff; border-radius:5px;">
                </div>
                <button class="action-btn primary" style="width:100%; margin-bottom:10px;" onclick="addTodo()">追加</button>
                <div class="todo-list" id="todo-list"></div>
            </div>

            <div class="widget">
                <h2>Weather</h2>
                <div id="weather-display" style="text-align:center;">
                    <button class="action-btn" onclick="getWeather()">現在地を取得</button>
                </div>
            </div>

            <div class="widget">
                <h2 id="cal-title">Calendar</h2>
                <div id="calendar" class="calendar-grid"></div>
            </div>

        </div>
    </div>

    <script>
        // === 初期化 & 共通 ===
        let audioCtx;
        function initAudio() {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        function playBeep() {
            if (!audioCtx) initAudio();
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'sine';
            osc.frequency.setValueAtTime(880, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.5, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + 0.5);
        }

        async function startApp() {
            document.getElementById('start-overlay').style.display = 'none';
            initAudio();
            loadTimerSetting(); // タイマー設定復元
            try { if ('wakeLock' in navigator) await navigator.wakeLock.request('screen'); } catch(e){}
            if (Notification.permission === 'default') Notification.requestPermission();
        }

        function toggleNightMode() {
            document.body.classList.toggle('night-mode');
            const btn = document.getElementById('mode-toggle');
            btn.innerText = document.body.classList.contains('night-mode') ? '☾' : '☀';
        }

        // === 左側スワイプ制御 ===
        function scrollToPage(index) {
            const container = document.getElementById('left-scroll');
            const width = container.offsetWidth;
            container.scrollTo({ left: width * index, behavior: 'smooth' });
        }

        function updateLeftTabs() {
            const container = document.getElementById('left-scroll');
            const width = container.offsetWidth;
            const index = Math.round(container.scrollLeft / width);
            
            // タブの見た目更新
            [0,1,2].forEach(i => {
                const btn = document.getElementById(`tab-btn-${i}`);
                if(i === index) btn.classList.add('active');
                else btn.classList.remove('active');
            });
        }

        // === 時計 & アラーム ===
        setInterval(() => {
            const now = new Date();
            const h = String(now.getHours()).padStart(2,'0');
            const m = String(now.getMinutes()).padStart(2,'0');
            const s = String(now.getSeconds()).padStart(2,'0');
            document.getElementById('clock').innerHTML = `${h}:${m}<span style="font-size:0.5em;">${s}</span>`;
            
            const days = ['日','月','火','水','木','金','土'];
            document.getElementById('date').innerText = `${now.getMonth()+1}月${now.getDate()}日 (${days[now.getDay()]})`;

            // アラームチェック
            if(alarmEnabled && alarmTimeVal === `${h}:${m}` && s === "00") {
                playBeep(); alert('Alarm!'); toggleAlarm();
            }
            // ToDo通知チェック
            checkTodoReminders(h, m, s);

        }, 1000);

        let alarmEnabled = false;
        let alarmTimeVal = "";
        function toggleAlarm() {
            const btn = document.getElementById('alarm-toggle');
            const input = document.getElementById('alarm-time');
            const status = document.getElementById('alarm-status');
            
            if (!alarmEnabled) {
                if(!input.value) return alert('時間を設定してください');
                alarmEnabled = true;
                alarmTimeVal = input.value;
                btn.innerText = "ON"; btn.classList.add('primary');
                status.innerText = `${alarmTimeVal} に設定中`;
            } else {
                alarmEnabled = false;
                btn.innerText = "OFF"; btn.classList.remove('primary');
                status.innerText = "設定なし";
            }
        }

        // === 新: 自由設定タイマー ===
        let timerInterval = null;
        let remainingSeconds = 0;
        let isRunning = false;

        // 設定の保存と読み込み（ローカルストレージ）
        function saveTimerSetting() {
            const min = document.getElementById('timer-min').value || 0;
            const sec = document.getElementById('timer-sec').value || 0;
            localStorage.setItem('my_timer_min', min);
            localStorage.setItem('my_timer_sec', sec);
            // タイマー停止中なら表示も更新
            if(!isRunning) {
                const m = String(min).padStart(2,'0');
                const s = String(sec).padStart(2,'0');
                document.getElementById('timer-display').innerText = `${m}:${s}`;
            }
        }

        function loadTimerSetting() {
            const min = localStorage.getItem('my_timer_min') || 3; // デフォルト3分
            const sec = localStorage.getItem('my_timer_sec') || 0;
            document.getElementById('timer-min').value = min;
            document.getElementById('timer-sec').value = sec;
            const m = String(min).padStart(2,'0');
            const s = String(sec).padStart(2,'0');
            document.getElementById('timer-display').innerText = `${m}:${s}`;
        }

        function toggleTimer() {
            if(isRunning) {
                // ストップ処理
                clearInterval(timerInterval);
                isRunning = false;
                document.getElementById('timer-btn').innerText = "Start";
                document.getElementById('timer-btn').classList.add('primary');
            } else {
                // スタート処理
                const min = parseInt(document.getElementById('timer-min').value) || 0;
                const sec = parseInt(document.getElementById('timer-sec').value) || 0;
                
                if(remainingSeconds === 0) remainingSeconds = (min * 60) + sec;
                if(remainingSeconds <= 0) return;

                isRunning = true;
                document.getElementById('timer-btn').innerText = "Stop";
                document.getElementById('timer-btn').classList.remove('primary');

                timerInterval = setInterval(() => {
                    if(remainingSeconds > 0) {
                        remainingSeconds--;
                        const dMin = Math.floor(remainingSeconds / 60).toString().padStart(2,'0');
                        const dSec = (remainingSeconds % 60).toString().padStart(2,'0');
                        document.getElementById('timer-display').innerText = `${dMin}:${dSec}`;
                    } else {
                        clearInterval(timerInterval);
                        isRunning = false;
                        playBeep(); alert('Time Up!');
                        document.getElementById('timer-btn').innerText = "Start";
                        document.getElementById('timer-btn').classList.add('primary');
                        remainingSeconds = 0; // リセット
                    }
                }, 1000);
            }
        }

        function resetTimer() {
            clearInterval(timerInterval);
            isRunning = false;
            remainingSeconds = 0;
            loadTimerSetting(); // 保存された設定に戻す
            document.getElementById('timer-btn').innerText = "Start";
            document.getElementById('timer-btn').classList.add('primary');
        }

        // === ToDoリスト（前回と同じだが再掲） ===
        let todos = JSON.parse(localStorage.getItem('todos_v4') || '[]');
        renderTodos();

        function addTodo() {
            const text = document.getElementById('todo-input').value;
            const time = document.getElementById('todo-time').value;
            if(!text) return;
            todos.push({ id: Date.now(), text, time, completed:false, notified:false });
            saveTodos();
            document.getElementById('todo-input').value = '';
        }
        function saveTodos() { localStorage.setItem('todos_v4', JSON.stringify(todos)); renderTodos(); }
        function deleteTodo(id) { todos = todos.filter(t => t.id !== id); saveTodos(); }
        function toggleTodo(id) { 
            const t = todos.find(x => x.id === id); 
            if(t) t.completed = !t.completed; 
            saveTodos(); 
        }
        function renderTodos() {
            const list = document.getElementById('todo-list');
            list.innerHTML = '';
            todos.forEach(t => {
                const div = document.createElement('div');
                div.className = `todo-item ${t.completed?'completed':''}`;
                div.innerHTML = `
                    <div class="checkbox ${t.completed?'checked':''}" onclick="toggleTodo(${t.id})"></div>
                    <div style="flex:1;">
                        <div>${t.text}</div>
                        ${t.time ? `<div style="font-size:0.8em; opacity:0.7;">⏰ ${t.time}</div>` : ''}
                    </div>
                    <button class="delete-btn" onclick="deleteTodo(${t.id})">×</button>
                `;
                list.appendChild(div);
            });
        }
        function checkTodoReminders(h, m, s) {
            if(s !== '00') return;
            const now = `${h}:${m}`;
            todos.forEach(t => {
                if(t.time === now && !t.completed && !t.notified) {
                    playBeep();
                    if(Notification.permission==='granted') new Notification(t.text);
                    t.notified = true;
                    saveTodos();
                }
            });
        }

        // === 天気とカレンダー ===
        function renderCalendar() {
            const now = new Date();
            const y = now.getFullYear(); const m = now.getMonth();
            document.getElementById('cal-title').innerText = `${y}年 ${m+1}月`;
            let html = '';
            ['日','月','火','水','木','金','土'].forEach(d => html+=`<div style="font-weight:bold; color:var(--theme-color);">${d}</div>`);
            const first = new Date(y, m, 1).getDay();
            const last = new Date(y, m+1, 0).getDate();
            for(let i=0; i<first; i++) html+=`<div></div>`;
            for(let i=1; i<=last; i++) {
                const isToday = i===now.getDate() ? 'cal-today' : '';
                html+=`<div class="${isToday}">${i}</div>`;
            }
            document.getElementById('calendar').innerHTML = html;
        }
        renderCalendar();

        function getWeather() {
            const d = document.getElementById('weather-display');
            d.innerHTML = 'Loading...';
            navigator.geolocation.getCurrentPosition(async (pos) => {
                try {
                    const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${pos.coords.latitude}&longitude=${pos.coords.longitude}&current_weather=true&timezone=auto`);
                    const data = await res.json();
                    const w = data.current_weather;
                    let wName = '晴れ';
                    if(w.weathercode > 3) wName = '曇り';
                    if(w.weathercode > 50) wName = '雨';
                    d.innerHTML = `<div class="weather-temp">${w.temperature}°</div><div style="font-size:2rem;">${wName}</div>`;
                } catch(e) { d.innerText = 'Error'; }
            });
        }
    </script>
</body>
</html>
