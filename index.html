<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Standby Pro V3</title>
    <style>
        :root {
            --theme-color: #fff;
            --bg-color: #000;
            --accent-color: #0a84ff; /* 青色アクセント */
            --danger-color: #ff453a;
            --dim-color: #333;
        }
        
        /* 夜間モード（赤） */
        body.night-mode {
            --theme-color: #ff453a;
            --accent-color: #ff453a;
            --dim-color: #591815;
        }

        body, html {
            margin: 0; padding: 0;
            background-color: var(--bg-color);
            color: var(--theme-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            height: 100%; overflow: hidden;
            transition: color 0.5s ease;
        }

        /* レイアウト：左40% : 右60% */
        .main-container {
            display: flex;
            width: 100vw; height: 100vh;
        }

        /* --- 左側：時計・アラーム・タイマー --- */
        .left-pane {
            flex: 0 0 40%; /* 幅固定40% */
            border-right: 1px solid #222;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .left-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            display: none; /* JSで切り替え */
        }
        .left-content.active { display: flex; }

        /* 左側タブボタン */
        .left-tabs {
            height: 50px;
            display: flex;
            justify-content: center;
            gap: 20px;
            padding-bottom: 20px;
        }
        .tab-btn {
            background: transparent; border: none;
            color: var(--theme-color); opacity: 0.4;
            font-size: 1.5rem; cursor: pointer;
        }
        .tab-btn.active { opacity: 1; font-weight: bold; border-bottom: 2px solid var(--theme-color); }

        /* 時計デザイン */
        .clock-time { font-size: 13vw; font-weight: 800; line-height: 0.9; font-variant-numeric: tabular-nums; }
        .clock-date { font-size: 3.5vw; margin-top: 10px; opacity: 0.8; }

        /* アラーム・タイマーUI */
        .input-group { display: flex; gap: 10px; align-items: center; margin: 10px 0; }
        input[type="time"], input[type="number"] {
            background: #222; border: 1px solid #444; color: #fff;
            font-size: 1.5rem; padding: 5px; border-radius: 8px;
        }
        .action-btn {
            padding: 8px 20px; font-size: 1.2rem; border-radius: 20px; border: none;
            background: var(--dim-color); color: var(--theme-color); cursor: pointer;
        }
        .action-btn.primary { background: var(--theme-color); color: var(--bg-color); }
        .timer-display { font-size: 8vw; font-weight: bold; font-variant-numeric: tabular-nums; }

        /* --- 右側：ウィジェット（スワイプ） --- */
        .right-pane {
            flex: 1; /* 残り全部(60%) */
            overflow-x: scroll;
            overflow-y: hidden;
            scroll-snap-type: x mandatory;
            display: flex;
        }

        .widget {
            flex: 0 0 100%; /* 親の幅(60vw)に対して100% = ピッタリはまる */
            height: 100%;
            scroll-snap-align: center;
            padding: 20px; box-sizing: border-box;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            overflow-y: auto; /* 縦スクロール許可（ToDo用） */
        }

        /* ToDoリストデザイン */
        .todo-input-container {
            width: 100%; display: flex; gap: 5px; margin-bottom: 15px;
        }
        .todo-text-input {
            flex: 1; background: #222; border: none; color: white;
            padding: 10px; border-radius: 8px; font-size: 1rem;
        }
        .todo-list {
            width: 100%; flex: 1; overflow-y: auto;
            display: flex; flex-direction: column; gap: 8px;
        }
        .todo-item {
            display: flex; align-items: center; gap: 10px;
            background: rgba(255,255,255,0.1); padding: 10px;
            border-radius: 8px; font-size: 1.1rem;
        }
        .todo-item.completed { opacity: 0.5; text-decoration: line-through; }
        .checkbox {
            width: 24px; height: 24px; border: 2px solid var(--theme-color);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
        }
        .checkbox.checked::after {
            content: '✔'; font-size: 16px; color: var(--theme-color);
        }
        .todo-time { font-size: 0.8em; opacity: 0.7; margin-left: auto; }
        .delete-btn { background: none; border: none; color: #888; font-size: 1.2rem; }

        /* 共通ボタン（夜間モードなど） */
        #mode-toggle {
            position: fixed; bottom: 15px; left: 15px;
            width: 40px; height: 40px; background: rgba(50,50,50,0.5);
            border-radius: 50%; border: none; color: #fff; z-index: 100;
        }

        /* 起動オーバーレイ */
        #start-overlay {
            position: fixed; inset: 0; background: #000; z-index: 999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
    </style>
</head>
<body>

    <div id="start-overlay">
        <h2 style="color:white;">Standby Pro V3</h2>
        <p style="color:#888;">音声を有効にするため<br>ボタンを押して開始してください</p>
        <button class="action-btn primary" onclick="startApp()">開始</button>
    </div>

    <button id="mode-toggle" onclick="toggleNightMode()">☀</button>

    <div class="main-container">
        <div class="left-pane">
            <div id="view-clock" class="left-content active">
                <div class="clock-time" id="clock">00:00</div>
                <div class="clock-date" id="date">1月1日(月)</div>
            </div>

            <div id="view-alarm" class="left-content">
                <h2>Alarm</h2>
                <input type="time" id="alarm-time">
                <div style="margin-top:10px;">
                    <button class="action-btn" id="alarm-toggle" onclick="toggleAlarm()">OFF</button>
                </div>
                <p id="alarm-status" style="margin-top:10px; color:#888;">設定なし</p>
            </div>

            <div id="view-timer" class="left-content">
                <h2>Timer</h2>
                <div class="timer-display" id="timer-display">00:00</div>
                <div class="input-group">
                    <button class="action-btn" onclick="setTimer(3)">3分</button>
                    <button class="action-btn" onclick="setTimer(5)">5分</button>
                    <button class="action-btn" onclick="setTimer(10)">10分</button>
                </div>
                <div>
                    <button class="action-btn primary" onclick="startTimer()">Start</button>
                    <button class="action-btn" onclick="resetTimer()">Reset</button>
                </div>
            </div>

            <div class="left-tabs">
                <button class="tab-btn active" onclick="switchLeft('clock', this)">時計</button>
                <button class="tab-btn" onclick="switchLeft('alarm', this)">アラーム</button>
                <button class="tab-btn" onclick="switchLeft('timer', this)">タイマー</button>
            </div>
        </div>

        <div class="right-pane">
            
            <div class="widget">
                <h2>ToDo & Reminder</h2>
                <div class="todo-input-container">
                    <input type="text" id="todo-input" class="todo-text-input" placeholder="予定を入力...">
                    <input type="time" id="todo-time-input" style="width:80px;">
                </div>
                <button class="action-btn primary" style="width:100%; margin-bottom:10px;" onclick="addTodo()">追加</button>
                
                <div class="todo-list" id="todo-list">
                    </div>
            </div>

            <div class="widget">
                <h2>Weather</h2>
                <div id="weather-display" style="text-align:center;">
                    <button class="action-btn" onclick="getWeather()">現在地を取得</button>
                </div>
            </div>

            <div class="widget">
                <h2 id="cal-title">Calendar</h2>
                <div id="calendar" style="display:grid; grid-template-columns:repeat(7,1fr); gap:8px; text-align:center; font-size:1.5rem; width:100%;"></div>
            </div>

        </div>
    </div>

    <script>
        // === オーディオコンテキスト（音用） ===
        let audioCtx;
        
        function initAudio() {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }

        function playBeep() {
            if (!audioCtx) initAudio();
            if (audioCtx.state === 'suspended') audioCtx.resume();
            
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'sine';
            osc.frequency.setValueAtTime(880, audioCtx.currentTime); // 880Hz (A5)
            osc.frequency.exponentialRampToValueAtTime(440, audioCtx.currentTime + 0.5);
            
            gain.gain.setValueAtTime(0.5, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);

            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.5);
        }

        // === アプリ共通 ===
        async function startApp() {
            document.getElementById('start-overlay').style.display = 'none';
            initAudio(); // 音の準備
            
            // Wake Lock
            try {
                if ('wakeLock' in navigator) await navigator.wakeLock.request('screen');
            } catch(e) {}
            
            // 通知許可
            if (Notification.permission === 'default') Notification.requestPermission();
        }

        function toggleNightMode() {
            document.body.classList.toggle('night-mode');
            const btn = document.getElementById('mode-toggle');
            btn.innerText = document.body.classList.contains('night-mode') ? '☾' : '☀';
        }

        // === 左側ロジック ===
        function switchLeft(viewId, btn) {
            document.querySelectorAll('.left-content').forEach(el => el.classList.remove('active'));
            document.getElementById('view-' + viewId).classList.add('active');
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            btn.classList.add('active');
        }

        // 時計
        setInterval(() => {
            const now = new Date();
            const h = String(now.getHours()).padStart(2,'0');
            const m = String(now.getMinutes()).padStart(2,'0');
            const s = String(now.getSeconds()).padStart(2,'0');
            document.getElementById('clock').innerHTML = `${h}:${m}<span style="font-size:0.5em;">${s}</span>`;
            
            const days = ['日','月','火','水','木','金','土'];
            document.getElementById('date').innerText = `${now.getMonth()+1}月${now.getDate()}日 (${days[now.getDay()]})`;

            checkAlarm(h, m);
            checkTodoReminders(h, m);
        }, 1000);

        // アラーム
        let alarmEnabled = false;
        let alarmTimeVal = "";
        
        function toggleAlarm() {
            const btn = document.getElementById('alarm-toggle');
            const input = document.getElementById('alarm-time');
            const status = document.getElementById('alarm-status');
            
            if (!alarmEnabled) {
                if(!input.value) return alert('時間を設定してください');
                alarmEnabled = true;
                alarmTimeVal = input.value;
                btn.innerText = "ON";
                btn.classList.add('primary');
                status.innerText = `${alarmTimeVal} に設定中`;
            } else {
                alarmEnabled = false;
                btn.innerText = "OFF";
                btn.classList.remove('primary');
                status.innerText = "設定なし";
            }
        }

        function checkAlarm(h, m) {
            if (alarmEnabled && alarmTimeVal === `${h}:${m}`) {
                playBeep();
                // 1分間鳴り続けないようにフラグ管理が必要だが、簡易的にアラートを出す
                // 実際は画面点滅などを入れたいが、ここでは簡易実装
                if(new Date().getSeconds() === 0) {
                    alert('アラームの時間です！');
                    toggleAlarm(); // OFFにする
                }
            }
        }

        // タイマー
        let timerInterval;
        let timerSeconds = 0;

        function setTimer(min) {
            timerSeconds = min * 60;
            updateTimerDisplay();
        }
        function updateTimerDisplay() {
            const m = Math.floor(timerSeconds / 60).toString().padStart(2,'0');
            const s = (timerSeconds % 60).toString().padStart(2,'0');
            document.getElementById('timer-display').innerText = `${m}:${s}`;
        }
        function startTimer() {
            if(timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                if(timerSeconds > 0) {
                    timerSeconds--;
                    updateTimerDisplay();
                } else {
                    clearInterval(timerInterval);
                    playBeep();
                    alert('タイマー終了');
                }
            }, 1000);
        }
        function resetTimer() {
            clearInterval(timerInterval);
            timerSeconds = 0;
            updateTimerDisplay();
        }

        // === 右側ロジック ===
        
        // ToDoリスト
        let todos = JSON.parse(localStorage.getItem('standby_todos') || '[]');
        renderTodos();

        function addTodo() {
            const text = document.getElementById('todo-input').value;
            const time = document.getElementById('todo-time-input').value;
            if(!text) return;
            
            todos.push({ id: Date.now(), text, time, completed: false, notified: false });
            saveTodos();
            document.getElementById('todo-input').value = '';
        }

        function toggleTodo(id) {
            const todo = todos.find(t => t.id === id);
            if(todo) todo.completed = !todo.completed;
            saveTodos();
        }

        function deleteTodo(id) {
            todos = todos.filter(t => t.id !== id);
            saveTodos();
        }

        function saveTodos() {
            localStorage.setItem('standby_todos', JSON.stringify(todos));
            renderTodos();
        }

        function renderTodos() {
            const list = document.getElementById('todo-list');
            list.innerHTML = '';
            todos.forEach(t => {
                const div = document.createElement('div');
                div.className = `todo-item ${t.completed ? 'completed' : ''}`;
                div.innerHTML = `
                    <div class="checkbox ${t.completed ? 'checked' : ''}" onclick="toggleTodo(${t.id})"></div>
                    <div>${t.text}</div>
                    ${t.time ? `<div class="todo-time">${t.time}</div>` : ''}
                    <button class="delete-btn" onclick="deleteTodo(${t.id})">×</button>
                `;
                list.appendChild(div);
            });
        }

        function checkTodoReminders(h, m) {
            const nowTime = `${h}:${m}`;
            todos.forEach(t => {
                if(t.time === nowTime && !t.completed && !t.notified) {
                    playBeep();
                    if(Notification.permission === 'granted') {
                        new Notification('リマインダー', { body: t.text });
                    }
                    t.notified = true; // 重複通知防止
                    saveTodos(); // フラグ保存
                }
            });
        }

        // カレンダー・天気は前回と同様（省略せずに記述）
        function renderCalendar() {
            // (前回のカレンダー描画コードと同様だが、レイアウト調整済みのHTMLに出力)
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            document.getElementById('cal-title').innerText = `${year}年 ${month+1}月`;
            
            const firstDay = new Date(year, month, 1).getDay();
            const lastDate = new Date(year, month+1, 0).getDate();
            
            let html = '';
            const weekDays = ['日','月','火','水','木','金','土'];
            weekDays.forEach(d => html += `<div style="font-weight:bold; color:var(--theme-color);">${d}</div>`);
            for(let i=0; i<firstDay; i++) html += `<div></div>`;
            for(let i=1; i<=lastDate; i++) {
                const isToday = i === now.getDate() ? 'background:var(--theme-color); color:var(--bg-color); border-radius:50%;' : '';
                html += `<div style="${isToday}">${i}</div>`;
            }
            document.getElementById('calendar').innerHTML = html;
        }
        renderCalendar();

        function getWeather() {
            const d = document.getElementById('weather-display');
            d.innerHTML = 'Loading...';
            navigator.geolocation.getCurrentPosition(async (pos) => {
                try {
                    const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${pos.coords.latitude}&longitude=${pos.coords.longitude}&current_weather=true&timezone=auto`);
                    const data = await res.json();
                    const w = data.current_weather;
                    
                    let wName = '晴れ';
                    if(w.weathercode > 3) wName = '曇り';
                    if(w.weathercode > 50) wName = '雨';

                    d.innerHTML = `
                        <div style="font-size:6rem; font-weight:bold;">${w.temperature}°</div>
                        <div style="font-size:2rem;">${wName}</div>
                    `;
                } catch(e) { d.innerText = 'Error'; }
            });
        }
    </script>
</body>
</html>
